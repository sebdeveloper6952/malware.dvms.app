import NDK, { NDKEvent, NDKKind, type NostrEvent } from '@nostr-dev-kit/ndk';
import { ndk } from './ndk';
import { writable, type Subscriber } from 'svelte/store';

export class NIP90Event extends NDKEvent {
	status: string = '';
	statusExtraInfo: string = '';
	amountMsat: number = 0;
	paymentRequest: string = '';

	constructor(ndk?: NDK, rawEvent?: NostrEvent) {
		super(ndk, rawEvent);

		rawEvent?.tags.forEach((tag) => {
			if (tag[0] === 'status') {
				this.status = tag[1] ?? '';
				this.statusExtraInfo = tag[2] ?? '';
			} else if (tag[0] === 'amount') {
				this.amountMsat = Number(tag[1] ?? 0);
				this.paymentRequest = tag[2] ?? '';
			}

			if (rawEvent.kind === 6500) {
				this.status = 'result';
			}
		});
	}

	static from(ndkEvent: NDKEvent) {
		return new NIP90Event(ndkEvent.ndk, ndkEvent.rawEvent());
	}
}

export const publishJobRequestEvent = async (
	input: string,
	pks: string[],
	bidMsat: number
): Promise<NDKEvent> => {
	const e = new NDKEvent(ndk);
	e.kind = 5500;
	e.tags = [['i', input, 'url'], ['bid', bidMsat.toString()], ...pks.map((pk) => ['p', pk])];
	await e.publish();

	return e;
};

export const subscribeToJobRequest = (eventId: string) => {
	let state = new Map<string, NIP90Event[]>();
	const store = writable(state);

	const sub = ndk.subscribe([{ kinds: [6500 as NDKKind, 7000 as NDKKind], '#e': [eventId] }], {
		closeOnEose: false
	});

	sub.on('event', (e: NDKEvent) => {
		if (!state.has(e.author.pubkey)) {
			state.set(e.author.pubkey, []);
		}

		state.get(e.author.pubkey)?.push(NIP90Event.from(e));
		store.set(state);
	});

	return {
		subscribe: (run: Subscriber<Map<string, NIP90Event[]>>) => {
			store.subscribe(run);

			return () => {
				sub.stop();
			};
		},
		set: store.set,
		update: store.update
	};
};

export const publishCustomerFeedbackEvent = async (
	content: string,
	feedback: string,
	jobResultEventId: string,
	dvmPubkey: string,
	resultKind: NDKKind
): Promise<NDKEvent> => {
	const e = new NDKEvent(ndk);
	e.kind = 7;
	e.content = content;
	e.tags = [
		['feedback', feedback],
		['e', jobResultEventId],
		['p', dvmPubkey],
		['k', resultKind.toString()]
	];
	await e.publish();

	return e;
};
