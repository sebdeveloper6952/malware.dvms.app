import { NIP90Event } from './nip90';
import { ndk } from './ndk';
import { writable, type Subscriber } from 'svelte/store';
import type { NDKEvent, NDKKind, NDKSubscription } from '@nostr-dev-kit/ndk';

export const jobRequestUpdatesStore = (eventId: string) => {
	let state = new Map<string, NIP90Event[]>();
	let store = writable(state);

	const filter = { kinds: [6500 as NDKKind, 7000 as NDKKind], '#e': [eventId] };
	const sub = ndk.subscribe(filter, {
		closeOnEose: false
	});

	sub.on('event', (e: NDKEvent) => {
		if (!state.has(e.author.pubkey)) {
			state.set(e.author.pubkey, []);
		}

		state.get(e.author.pubkey)?.push(NIP90Event.from(e));
		store.set(state);
	});

	const subscribe = (run: Subscriber<Map<string, NIP90Event[]>>): (() => void) => {
		store.subscribe(run);

		return unsubscribe;
	};

	const unsubscribe = () => {
		setTimeout(() => {
			sub.stop();
		}, 1000);
	};

	return {
		subscribe: subscribe,
		set: store.set,
		update: store.update
	};
};
