import { malwareScanningResultKind } from '@lib/nostr/kinds';
import { ndk } from '@nostr/ndk';
import { Nip90JobResultEvent } from '@lib/models/Nip90JobResult';
import type { NDKEventStore } from '@nostr-dev-kit/ndk-svelte';

let store: NDKEventStore<Nip90JobResultEvent> | null = null;

const oneDaySeconds = 24 * 60 * 60;
let since = Math.round(Date.now() / 1000 - oneDaySeconds);
let until = Math.round(Date.now() / 1000);
let limit = 50;

export const getUserJobResultsStore = () => {
	if (ndk?.activeUser && store === null) {
		store = ndk.storeSubscribe(
			[
				{
					kinds: [malwareScanningResultKind],
					'#p': [ndk.activeUser.pubkey],
					limit: limit
				}
			],
			{
				closeOnEose: false,
				autoStart: false
			},
			Nip90JobResultEvent
		);
	}

	return store;
};

export const close = () => {
	// TODO
};
