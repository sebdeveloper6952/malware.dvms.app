<script lang="ts">
	import { setSk } from '@nostr/nsecSigner';
	import { userStore, logout } from '@nostr/nsecSigner';
	import BaseModal from '@components/modals/BaseModal.svelte';
	import FilledButton from '@components/buttons/FilledButton.svelte';
	import TextInput from '@components/forms/TextInput.svelte';
	import Icon from '@iconify/svelte';
	import TextButton from '../buttons/TextButton.svelte';

	let showDropdown = false;
	let showNsecModal = false;
	let sk = '';

	$: loginDisabled = sk === '';

	const onSetSk = async () => {
		await setSk(sk);
		showNsecModal = false;
		sk = '';
	};

	const onLogout = () => {
		logout();
		showDropdown = !showDropdown;
	};
</script>

<div class="p-2 flex items-center relative">
	<a href="/" class="flex gap-2">
		<Icon icon="pixelarticons:eye" width="24" height="24" />
		<p class="font-bold">Malware DVMs</p>
	</a>
	<div class="grow"></div>
	{#if $userStore}
		<button
			on:click={() => {
				showDropdown = !showDropdown;
			}}
		>
			<img
				src={`https://robohash.org/${$userStore.pubkey}`}
				alt="profile"
				class="w-10 h-10 p-px ring ring-orange-700 rounded-full"
			/>
		</button>
	{:else}
		<FilledButton
			on:click={() => {
				showNsecModal = true;
			}}>Login</FilledButton
		>
	{/if}

	{#if showDropdown}
		<div class="flex flex-col bg-zinc-800 rounded-md absolute top-14 right-2 z-50">
			<button
				on:click={onLogout}
				class="py-1 px-12 flex gap-2 hover:bg-zinc-700 cursor-pointer rounded-md"
			>
				<p>Logout</p>
			</button>
		</div>
	{/if}

	<BaseModal show={showNsecModal} on:close={() => (showNsecModal = false)}>
		<div class="px-16 py-4">
			<div class="w-full flex justify-center">
				<Icon icon="pixelarticons:lock-open" width="48" height="48" />
			</div>
			<p class="mt-4 text-2xl font-bold">Login with Private Key</p>
			<p class="mt-4">Your nsec will be saved in local storage, you can logout at any time.</p>
			<div class="mt-4">
				<text-input v-model="sk" type="password" />
			</div>
			<div class="flex flex-col gap-2 justify-center">
				<TextInput bind:value={sk} type="password" />
			</div>
			<div class="mt-4 w-full flex justify-end">
				<TextButton on:click={() => (showNsecModal = false)}>Cancel</TextButton>
				<TextButton on:click={onSetSk} disabled={loginDisabled}>Login</TextButton>
			</div>
		</div>
	</BaseModal>
</div>
