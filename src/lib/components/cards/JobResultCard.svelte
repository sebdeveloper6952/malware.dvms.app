<script lang="ts">
	import dayjs from 'dayjs';
	import type { DVMJobResultEvent } from '@lib/nostr/jobResults';
	import Icon from '@iconify/svelte';
	import { getPreview } from '@lib/helpers/linkPreview';
	import Accordion from '../Accordion.svelte';

	export let event: DVMJobResultEvent;

	$: extraInfo = event.permissions && event.permissions.length;
</script>

<div class="w-full bg-zinc-800 rounded-3xl">
	{#await event.init()}
		<p>loading...</p>
	{:then}
		<div class="p-4 w-full flex flex-col relative">
			{#if event.created_at}
				<div class="flex items-center absolute top-2 right-2">
					<p class="text-gray-500 text-xs">{dayjs.unix(event.created_at).format('lll')}</p>
				</div>
			{/if}
			<div class="flex justify-between">
				<div class="flex flex-col">
					<img src={event.author.profile?.image} alt="profile" class="w-16 h-16 rounded" />
					<p class="text-sm font-bold">{event.author.profile?.name}</p>
				</div>
			</div>
			<p>scanned:</p>

			{#if event?.jobRequestEvent?.inputs}
				{#each event.jobRequestEvent.inputs as item}
					{#await getPreview(event.jobRequestEvent?.inputs[0].value ?? '') then preview}
						<a href={preview.transformedUrl} target="_blank"
							><div class="flex flex-col md:flex-row items-center bg-zinc-900 rounded">
								<img src={preview.imageUrl} alt="" class="w-48 h-full object-contain rounded" />
								<div class="p-4">
									<p>{preview.title}</p>
									<p class="text-xs text-gray-400">{preview.description}</p>
								</div>
							</div></a
						>
					{:catch}
						<div class="w-fit px-4 py-2 flex gap-1 items-center bg-zinc-900 rounded-xl text-xs">
							<a href={item.value} target="_blank" class="w-fit font-mono">{item.value}</a>
							<Icon icon="pixelarticons:open" width="16" height="16" />
						</div>
					{/await}
				{/each}
			{/if}

			<p>and the result was:</p>
			<code class="p-4 w-fit bg-zinc-900 rounded-xl whitespace-pre text-xs">{event.content}</code>

			{#if extraInfo}
				<p>Extra Information</p>
				{#if event.permissions}
					<Accordion>
						<p slot="title">Permissions</p>
						{#each event.permissions as prm}
							<p class="text-xs text-gray-500">{prm}</p>
						{/each}
					</Accordion>
				{/if}
				{#if event.certificate}
					<Accordion>
						<p slot="title">Certificate</p>
						{#each event.certificate as crt}
							<p class="text-xs text-gray-500">{crt[0]}: {crt[1]}</p>
						{/each}
					</Accordion>
				{/if}
			{/if}
		</div>
	{/await}
</div>
