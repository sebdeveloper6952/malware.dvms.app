<script lang="ts">
	import { fetchProfile } from '@lib/nostr/profiles';
	import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
	import { onMount, createEventDispatcher } from 'svelte';
	import OutlinedButton from '../buttons/OutlinedButton.svelte';
	import JobStatusPill from '../JobStatusPill.svelte';
	import PaymentRequestModal from '@lib/components/modals/PaymentRequestModal.svelte';
	import { malwareScanningResultKind } from '@lib/nostr/kinds';
	import JobResultDetails from '@lib/components/JobResultDetails.svelte';
	import type { Nip90JobResultEvent } from '@lib/models/Nip90JobResult';

	interface ComponentEvent {
		selected: { id: string; author: string };
		payment: { pr: string; msat: number };
	}

	export let pk: string;
	export let events: Nip90JobResultEvent[];

	let profile: NDKUserProfile | null;
	let image = 'https://robohash.org/' + pk;
	let showPaymentRequestModal = false;
	let paid = false;

	$: if (profile && profile.image) {
		image = profile.image;
	}
	$: latestEvent = events[events.length - 1];

	const dispatch = createEventDispatcher<ComponentEvent>();

	onMount(async () => {
		profile = await fetchProfile(pk);
	});
</script>

<div class="p-4 w-full bg-zinc-800 rounded-3xl relative">
	<!-- profile image and title row -->
	<div class="w-full h-full flex">
		{#if profile}
			<div class="flex flex-col">
				<img src={image} alt="profile" class="mt-4 w-32 h-fit rounded-3xl" />
				<p>{profile.name}</p>
			</div>
		{/if}
	</div>

	<!-- show job status always at the top right corner -->
	<div class="absolute top-4 right-4">
		<JobStatusPill status={latestEvent.status} />
	</div>

	<!-- show the inner details of the job result content -->
	{#if latestEvent.kind === malwareScanningResultKind}
		<JobResultDetails event={latestEvent} />

		<div class="mt-4 w-full flex justify-end gap-2">
			{#if (!paid && latestEvent.paymentRequest !== '') || latestEvent.amountMsat !== 0}
				<OutlinedButton
					on:click={() => {
						showPaymentRequestModal = true;
					}}>Pay {latestEvent.amountMsat / 1000} sats</OutlinedButton
				>
			{/if}
			<OutlinedButton
				on:click={() => {
					dispatch('selected', { id: latestEvent.id, author: latestEvent.author.pubkey });
				}}>Rate job result</OutlinedButton
			>
		</div>
	{/if}
</div>

<div class="fixed top-0 left-0">
	<PaymentRequestModal
		show={showPaymentRequestModal}
		pr={latestEvent.paymentRequest}
		msat={latestEvent.amountMsat}
		on:close={() => {
			showPaymentRequestModal = false;
		}}
		on:paid={() => {
			paid = true;
			showPaymentRequestModal = false;
		}}
	></PaymentRequestModal>
</div>
