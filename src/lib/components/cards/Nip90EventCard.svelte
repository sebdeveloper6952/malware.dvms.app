<script lang="ts">
	import type { NIP90Event } from '@lib/nostr/nip90';
	import { fetchProfile } from '@lib/nostr/profiles';
	import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
	import { onMount, createEventDispatcher } from 'svelte';
	import OutlinedButton from '../buttons/OutlinedButton.svelte';
	import JobStatusPill from '../JobStatusPill.svelte';

	interface ComponentEvent {
		selected: { id: string; author: string };
	}

	export let pk: string;
	export let events: NIP90Event[];

	let profile: NDKUserProfile | null;
	let image = 'https://robohash.org/' + pk;
	let showRateJobModal = false;

	$: if (profile && profile.image) {
		image = profile.image;
	}
	$: latestEvent = events[events.length - 1];

	const dispatch = createEventDispatcher<ComponentEvent>();

	onMount(async () => {
		profile = await fetchProfile(pk);
	});
</script>

<div class="p-4 w-full bg-zinc-800 rounded-3xl relative">
	<div class="absolute top-4 right-4">
		<JobStatusPill status={latestEvent.status} />
	</div>
	<div class="w-full h-full flex">
		{#if profile}
			<div class="flex flex-col">
				<img src={image} alt="profile" class="mt-4 w-32 h-fit rounded-3xl" />
				<p>{profile.name}</p>
			</div>
		{/if}
		<div class="w-full h-full flex justify-center items-center">
			{#if latestEvent.status === 'result'}
				<p class="whitespace-pre">{latestEvent.content}</p>
			{/if}
		</div>
	</div>
	{#if latestEvent.status === 'result'}
		<div class="mt-4 w-full flex justify-end">
			<OutlinedButton
				on:click={() => {
					dispatch('selected', { id: latestEvent.id, author: latestEvent.author.pubkey });
				}}>Rate job result</OutlinedButton
			>
		</div>
	{/if}
</div>
