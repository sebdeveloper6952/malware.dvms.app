<script lang="ts">
	import { onDestroy, onMount } from 'svelte';
	import type { ComponentEvents } from 'svelte';
	import type { Writable } from 'svelte/store';
	import autoAnimate from '@formkit/auto-animate';
	import Nip89DvmCard from '@lib/components/cards/Nip89DvmCard.svelte';
	import { nip89Store } from '@lib/stores/nip89';
	import { publishJobRequestEvent } from '@lib/nostr/nip90';
	import URLInputWithButton from '@lib/components/forms/URLInputWithButton.svelte';
	import Nip90EventCard from '@lib/components/cards/Nip90EventCard.svelte';
	import RateJobResultModal from '@components/modals/RateJobResultModal.svelte';
	import OutlinedButton from '@lib/components/buttons/OutlinedButton.svelte';
	import { jobRequestUpdatesStore } from '@lib/stores/jobRequestUpdates';
	import type { Nip90JobFeedback } from '@lib/models/Nip90JobFeedback';

	let prompt = '';
	let jobStep = 0;
	let showRateJobModal = false;
	let showPaymentRequestModal = false;
	let selectedResultEventId = '';
	let selectedResultAuthorPubkey = '';
	let paymentRequest = '';
	let paymentRequestMsat = 0;
	let dvmsSelected = new Set<string>();
	let jobUpdatesSub: Writable<Map<string, Nip90JobFeedback[]>>;

	$: selectDvmsButtonText =
		dvmsSelected.size > 0
			? dvmsSelected.size === 1
				? `Prompt 1 DVM`
				: 'Prompt ' + dvmsSelected.size + ' DVMs'
			: 'Prompt all DVMs';

	onMount(() => {
		nip89Store.ref();
	});

	onDestroy(() => {
		nip89Store.unref();
	});

	const onPromptSubmit = (e: ComponentEvents<URLInputWithButton>['submit']) => {
		jobStep = 1;
		prompt = e.detail.value;
	};

	const onDvmsSubmit = async () => {
		jobStep = 2;
		const event = await publishJobRequestEvent(prompt, Array.from(dvmsSelected), 1000);
		jobUpdatesSub = jobRequestUpdatesStore(event.id);
	};

	const onDvmSelected = async (e: ComponentEvents<Nip89DvmCard>['selected']) => {
		if (dvmsSelected.has(e.detail.pk)) dvmsSelected.delete(e.detail.pk);
		else dvmsSelected.add(e.detail.pk);
		dvmsSelected = dvmsSelected;
	};

	const onReset = () => {
		prompt = '';
		dvmsSelected.clear();
		dvmsSelected = dvmsSelected;
		jobStep = 0;
	};
</script>

<div class="w-full flex justify-center">
	<div class="w-full md:max-w-screen-md">
		<!-- step 1 -->
		{#if jobStep === 0}
			<div class="p-2 w-full flex flex-col items-center">
				<div class="w-full">
					<div class="w-full flex justify-center">
						<p class="font-bold">Enter a URL to scan its contents:</p>
					</div>
					<div class="mt-4">
						<URLInputWithButton value={prompt} on:submit={onPromptSubmit} />
					</div>
				</div>
			</div>

			<!-- step 2 -->
		{:else if jobStep === 1}
			<div class="w-full flex flex-col">
				<div class="w-full flex flex-col justify-center items-center">
					<p class="font-bold">Select specific DVM(s) or prompt all:</p>
					<div class="mt-2">
						<OutlinedButton on:click={onDvmsSubmit}>{selectDvmsButtonText}</OutlinedButton>
					</div>
				</div>

				<div class="mt-4 w-full grid grid-cols-1 gap-2">
					{#each $nip89Store as e}
						<div class="w-full">
							<Nip89DvmCard
								on:selected={onDvmSelected}
								event={e}
								selectable
								selected={dvmsSelected.has(e.author.pubkey)}
							/>
						</div>
					{/each}
				</div>
			</div>

			<!-- step 3 -->
		{:else if jobStep === 2 && jobUpdatesSub}
			<div class="w-full flex justify-center">
				<OutlinedButton on:click={onReset}>Scan another</OutlinedButton>
			</div>
			<ul use:autoAnimate={{ duration: 1000 }}>
				{#each $jobUpdatesSub as [pk, events]}
					<li class="my-4">
						<Nip90EventCard
							{pk}
							{events}
							on:selected={(e) => {
								selectedResultEventId = e.detail.id;
								selectedResultAuthorPubkey = e.detail.author;
								showRateJobModal = true;
							}}
							on:payment={(e) => {
								paymentRequest = e.detail.pr;
								paymentRequestMsat = e.detail.msat;
								showPaymentRequestModal = true;
							}}
						/>
					</li>
				{/each}
			</ul>
		{/if}
	</div>
</div>

<RateJobResultModal
	show={showRateJobModal}
	eventId={selectedResultEventId}
	authorPubkey={selectedResultAuthorPubkey}
	on:close={() => {
		showRateJobModal = false;
	}}
></RateJobResultModal>
